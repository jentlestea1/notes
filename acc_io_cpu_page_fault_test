加速器IO/CPU page fault时延测试
===============================

-v0.1 2021.2.24 Sherlock init
-v0.2 2021.2.28 Sherlock 增加有内存背景噪声的测试

0. 测试环境:
------------

1. numactl -H

available: 4 nodes (0-3)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31
node 0 size: 0 MB
node 0 free: 0 MB
node 1 cpus: 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63
node 1 size: 31908 MB
node 1 free: 30405 MB
node 2 cpus: 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95
node 2 size: 0 MB
node 2 free: 0 MB
node 3 cpus: 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127
node 3 size: 32083 MB
node 3 free: 31433 MB
node distances:
node   0   1   2   3 
  0:  10  12  20  22 
  1:  12  10  22  24 
  2:  20  22  10  12 
  3:  22  24  12  10 

2. dmidecode | grep BIOS

Getting SMBIOS data from sysfs.
SMBIOS 3.1.1 present.
# SMBIOS implementations newer than version 3.0 are not
BIOS Information
	Version: TA BIOS 2280-A CS V2.B220.01
		BIOS is upgradeable
		BIOS shadowing is allowed
		BIOS boot specification is supported
	BIOS Revision: 0.0
BIOS Language Information

3. uname -a

Linux ubuntu 5.11.0-rc4-g0fdcd6aaf7c2-dirty #25 SMP PREEMPT Tue Feb 23 11:04:29 UTC 2021 aarch64 aarch64 aarch64 GNU/Linux

4. 需要在内核加上如下补丁：
https://github.com/Linaro/linux-kernel-uadk uacce-devel-5.11
```
diff --git a/arch/arm64/mm/fault.c b/arch/arm64/mm/fault.c
index 3c40da4..ac07431 100644
--- a/arch/arm64/mm/fault.c
+++ b/arch/arm64/mm/fault.c
@@ -41,6 +41,8 @@
 #include <asm/tlbflush.h>
 #include <asm/traps.h>
 
+#include <trace/events/smmu.h>
+
 struct fault_info {
 	int	(*fn)(unsigned long far, unsigned int esr,
 		      struct pt_regs *regs);
@@ -655,9 +657,14 @@ static int __kprobes do_translation_fault(unsigned long far,
 					  struct pt_regs *regs)
 {
 	unsigned long addr = untagged_addr(far);
+	int ret;
 
-	if (is_ttbr0_addr(addr))
-		return do_page_fault(far, esr, regs);
+	if (is_ttbr0_addr(addr)) {
+		trace_cpu_fault_entry(far);
+		ret = do_page_fault(far, esr, regs);
+		trace_cpu_fault_exit(far);
+		return ret;
+	}
 
 	do_bad_area(far, esr, regs);
 	return 0;
diff --git a/drivers/iommu/arm/arm-smmu-v3/arm-smmu-v3.c b/drivers/iommu/arm/arm-smmu-v3/arm-smmu-v3.c
index 8d29aa1..d38dd13 100644
--- a/drivers/iommu/arm/arm-smmu-v3/arm-smmu-v3.c
+++ b/drivers/iommu/arm/arm-smmu-v3/arm-smmu-v3.c
@@ -32,6 +32,8 @@
 
 #include <linux/amba/bus.h>
 
+#include <trace/events/smmu.h>
+
 #include "arm-smmu-v3.h"
 #include "../../iommu-sva-lib.h"
 
@@ -945,6 +947,8 @@ static int arm_smmu_page_response(struct device *dev,
 	 * forget.
 	 */
 
+	trace_io_fault_exit(dev, resp->pasid, evt->fault.prm.addr);
+
 	return 0;
 }
 
@@ -1474,6 +1478,9 @@ static int arm_smmu_handle_evt(struct arm_smmu_device *smmu, u64 *evt)
 	struct iommu_fault_event fault_evt = { };
 	struct iommu_fault *flt = &fault_evt.fault;
 
+	trace_io_fault_entry(smmu->dev, FIELD_GET(EVTQ_0_SSID, evt[0]),
+			     FIELD_GET(EVTQ_2_ADDR, evt[2]));
+
 	/* Stage-2 is always pinned at the moment */
 	if (evt[1] & EVTQ_1_S2)
 		return -EFAULT;
diff --git a/include/trace/events/smmu.h b/include/trace/events/smmu.h
index e9b6484..e24101a 100644
--- a/include/trace/events/smmu.h
+++ b/include/trace/events/smmu.h
@@ -82,6 +82,50 @@ DEFINE_EVENT(smmu_mn, smmu_mn_free, TP_PROTO(unsigned int pasid), TP_ARGS(pasid)
 DEFINE_EVENT(smmu_mn, smmu_mn_get, TP_PROTO(unsigned int pasid), TP_ARGS(pasid));
 DEFINE_EVENT(smmu_mn, smmu_mn_put, TP_PROTO(unsigned int pasid), TP_ARGS(pasid));
 
+DECLARE_EVENT_CLASS(smmu_io_fault_class,
+	TP_PROTO(struct device *dev, unsigned int pasid, u64 va),
+	TP_ARGS(dev, pasid, va),
+
+	TP_STRUCT__entry(
+		__string(dev, dev_name(dev))
+		__field(int, pasid)
+		__field(u64, va)
+	),
+	TP_fast_assign(
+		__assign_str(dev, dev_name(dev));
+		__entry->pasid = pasid;
+		__entry->va = va;
+	),
+	TP_printk("dev=%s pasid=%d, va=%llx", __get_str(dev), __entry->pasid,
+		   __entry->va)
+);
+
+#define DEFINE_IO_FAULT_EVENT(name)       \
+DEFINE_EVENT(smmu_io_fault_class, name,        \
+	TP_PROTO(struct device *dev, unsigned int pasid, u64 va), \
+	TP_ARGS(dev, pasid, va))
+
+DEFINE_IO_FAULT_EVENT(io_fault_entry);
+DEFINE_IO_FAULT_EVENT(io_fault_exit);
+
+DECLARE_EVENT_CLASS(smmu_cpu_fault_class,
+	TP_PROTO(u64 va),
+	TP_ARGS(va),
+
+	TP_STRUCT__entry(
+		__field(u64, va)
+	),
+	TP_fast_assign(
+		__entry->va = va;
+	),
+	TP_printk("va=%llx", __entry->va)
+);
+
+#define DEFINE_CPU_FAULT_EVENT(name)       \
+DEFINE_EVENT(smmu_cpu_fault_class, name, TP_PROTO(u64 va), TP_ARGS(va))
+
+DEFINE_CPU_FAULT_EVENT(cpu_fault_entry);
+DEFINE_CPU_FAULT_EVENT(cpu_fault_exit);
 
 #endif /* _TRACE_SMMU_H */
```

5. 用户态使用如下ebpf脚本:
```
#!/usr/bin/python3
#
from __future__ import print_function
from bcc import BPF
from ctypes import c_ushort, c_int, c_ulonglong
from time import sleep
from sys import argv

def usage():
        print("USAGE: %s [interval [count]]" % argv[0])
        exit()

# arguments
interval = 500
count = -1
if len(argv) > 1:
        try:
                interval = int(argv[1])
                if interval == 0:
                        raise
                if len(argv) > 2:
                        count = int(argv[2])
        except: # also catches -h, --help
                usage()

# load BPF program
b = BPF(text="""
#include <uapi/linux/ptrace.h>

BPF_HASH(start, u64);
BPF_HISTOGRAM(dist);

BPF_HASH(cpu_start, u64);
BPF_HISTOGRAM(cpu_dist);

TRACEPOINT_PROBE(smmu, io_fault_entry)
{
        u64 ts;
	u64 va = args->va;

	ts = bpf_ktime_get_ns();
        start.update(&va, &ts);

        return 0;
}

TRACEPOINT_PROBE(smmu, io_fault_exit)
{
        u64 *tsp, delta;
	u64 va = args->va;

        tsp = start.lookup(&va);

        if (tsp != 0) {
                delta = bpf_ktime_get_ns() - *tsp;
                dist.increment(bpf_log2l(delta));
                start.delete(&va);
        }

        return 0;
}

TRACEPOINT_PROBE(smmu, cpu_fault_entry)
{
        u64 ts;
	u64 va = args->va;

	ts = bpf_ktime_get_ns();
        cpu_start.update(&va, &ts);

        return 0;
}

TRACEPOINT_PROBE(smmu, cpu_fault_exit)
{
        u64 *tsp, delta;
	u64 va = args->va;

        tsp = cpu_start.lookup(&va);

        if (tsp != 0) {
                delta = bpf_ktime_get_ns() - *tsp;
                cpu_dist.increment(bpf_log2l(delta));
                cpu_start.delete(&va);
        }

        return 0;
}
""")

# header
print("Tracing... Hit Ctrl-C to end.")

# output
loop = 0
do_exit = 0
while (1):
        if count > 0:
                loop += 1
                if loop > count:
                        exit()
        try:
                sleep(interval)
        except KeyboardInterrupt:
                pass; do_exit = 1

        print("io pf duration dist:")
        b["dist"].print_log2_hist("nsecs")
        b["dist"].clear()

        print("cpu pf duration dist:")
        b["cpu_dist"].print_log2_hist("nsecs")
        b["cpu_dist"].clear()

        if do_exit:
                exit()
```

6. 使用zip设备做测试, 做1000000个8K大小包的压缩。
   开THP是：echo always > /sys/kernel/mm/transparent_hugepage/enable
   

1. 硬件加速 + 开THP + 绑cpu/mem + 不pre-fault
---------------------------------------------

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 203      |*                                       |
      8192 -> 16383      : 16       |                                        |
     16384 -> 32767      : 0        |                                        |
     32768 -> 65535      : 1        |                                        |
     65536 -> 131071     : 0        |                                        |
    131072 -> 262143     : 1        |                                        |
    262144 -> 524287     : 7810     |****************************************|

cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 46       |                                        |
      1024 -> 2047       : 2504     |*************************               |
      2048 -> 4095       : 511      |*****                                   |
      4096 -> 8191       : 47       |                                        |
      8192 -> 16383      : 7        |                                        |
     16384 -> 32767      : 2        |                                        |
     32768 -> 65535      : 0        |                                        |
     65536 -> 131071     : 0        |                                        |
    131072 -> 262143     : 11       |                                        |
    262144 -> 524287     : 3895     |****************************************|

Compress bz=8192 nb=1×1000000, speed=1229.8 MB/s (±0.0% N=1) overall=1228.8 MB/s (±0.0%)


2. 硬件加速 + 关THP + 绑cpu/mem + 不pre-fault
---------------------------------------------

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 819

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 6163     |                                        |
      8192 -> 16383      : 1993601  |****************************************|
     16384 -> 32767      : 227      |                                        |
     32768 -> 65535      : 8        |                                        |
     65536 -> 131071     : 1        |                                        |
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 1        |                                        |
       512 -> 1023       : 62003    |*                                       |
      1024 -> 2047       : 1770975  |****************************************|
      2048 -> 4095       : 1093012  |************************                |
      4096 -> 8191       : 76250    |*                                       |
      8192 -> 16383      : 305      |                                        |
     16384 -> 32767      : 6        |                                        |

Compress bz=8192 nb=1×1000000, speed=223.0 MB/s (±0.0% N=1) overall=223.0 MB/s (±0.0%)

结论1：开THP会触发内核做collapse huge page, 虽然有少量长延时IOPF, 但是，短延时
       IOPF大大减少，加速器总性能提升。这样看THP是SVA性能提升的一个方向。


3. 硬件加速 + 关THP + 不绑cpu/mem + pre-fault
---------------------------------------------

sudo zip_sva_perf -b 8192 -s 8192000000 -o perf

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 3087584  |****************************************|
      8192 -> 16383      : 3017774  |*************************************** |
     16384 -> 32767      : 9167     |                                        |
     32768 -> 65535      : 19       |                                        |
     65536 -> 131071     : 2        |                                        |
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 1        |                                        |
       512 -> 1023       : 754003   |******                                  |
      1024 -> 2047       : 4878301  |****************************************|
      2048 -> 4095       : 1237359  |**********                              |
      4096 -> 8191       : 3407     |                                        |
      8192 -> 16383      : 561      |                                        |
     16384 -> 32767      : 37       |                                        |
     32768 -> 65535      : 3        |                                        |

Compress bz=8192 nb=1×1000000, speed=93.3 MB/s (±0.0% N=1) overall=86.0 MB/s (±0.0%)

结论2: 提前用cpu触发page fault, numa balancing也会触发IOPF。严重影响性能。

基于和3相同的配置，我们测试纯cpu计算zlib，和用加速器计算。统计page fault时，全部
把pre-fault时产生的不统计，为此我们在pre-fault之后加入一段30s的sleep，在htop上
观测pre-fault(memset)彻底过去，在sleep 30的这段时间启动用户态统计脚本。我们得到
这样的数据：

sudo zip_sva_perf -b 8192 -s 8192000000 -o perf -c -z (cpu计算)

Tracing... Hit Ctrl-C to end.
io pf duration dist:
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 124358   |*****                                   |
       512 -> 1023       : 845926   |****************************************|
      1024 -> 2047       : 43147    |**                                      |
      2048 -> 4095       : 384      |                                        |
      4096 -> 8191       : 96446    |****                                    |
      8192 -> 16383      : 2415     |                                        |
     16384 -> 32767      : 19       |                                        |
     32768 -> 65535      : 3        |                                        |

Compress bz=8192 nb=1×1000000, speed=67.8 MB/s (±0.0% N=1) overall=51.9 MB/s (±0.0%)


sudo zip_sva_perf -b 8192 -s 8192000000 -o perf -z (使用加速器)

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 1053170  |*************                           |
      8192 -> 16383      : 3168227  |****************************************|
     16384 -> 32767      : 75727    |                                        |
     32768 -> 65535      : 32       |                                        |
     65536 -> 131071     : 5        |                                        |
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 137      |                                        |
      1024 -> 2047       : 66180    |***                                     |
      2048 -> 4095       : 671266   |****************************************|
      4096 -> 8191       : 453      |                                        |
      8192 -> 16383      : 60       |                                        |
     16384 -> 32767      : 7        |                                        |

Compress bz=8192 nb=1×1000000, speed=109.7 MB/s (±0.0% N=1) overall=73.3 MB/s (±0.0%)

结论2-e：同样的任务，numa balancing产生的page fault时延，CPU page fault的时延
         集中在1us之下，IOPT的时延集中在8us之上。


4. 硬件加速 + 开THP + 绑cpu/mem + pre-fault
-------------------------------------------

结论3: 提前用cpu触发page fault, 绑cpu/mem, 没有iopf。(也可能是测试次数太少)


5. 硬件加速和CPU + 关THP + 绑cpu/mem + 不pre-fault
--------------------------------------------------

加速器做：

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000 -z

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 1707304  |****************************************|
      8192 -> 16383      : 292589   |******                                  |
     16384 -> 32767      : 103      |                                        |
     32768 -> 65535      : 2        |                                        |
     65536 -> 131071     : 2        |                                        |
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 3        |                                        |
      1024 -> 2047       : 26955    |*                                       |
      2048 -> 4095       : 942509   |****************************************|
      4096 -> 8191       : 30321    |*                                       |
      8192 -> 16383      : 223      |                                        |
     16384 -> 32767      : 7        |                                        |
     32768 -> 65535      : 3        |                                        |

Compress bz=8192 nb=1×1000000, speed=266.0 MB/s (±0.0% N=1) overall=131.6 MB/s (±0.0%)

CPU做：

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000 -z -c

Tracing... Hit Ctrl-C to end.
io pf duration dist:
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 25862    |*                                       |
      1024 -> 2047       : 726748   |****************************************|
      2048 -> 4095       : 100241   |*****                                   |
      4096 -> 8191       : 1964     |                                        |
      8192 -> 16383      : 66       |                                        |
     16384 -> 32767      : 3        |                                        |
     32768 -> 65535      : 2        |                                        |

Compress bz=8192 nb=1×1000000, speed=68.7 MB/s (±0.0% N=1) overall=54.4 MB/s (±0.0%)

疑问：IOPF的数量太多？


6. 硬件加速和CPU + 开THP + 绑cpu/mem + 不pre-fault
--------------------------------------------------

加速器做：

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000 -z

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 160      |                                        |
      8192 -> 16383      : 17       |                                        |
     16384 -> 32767      : 1        |                                        |
     32768 -> 65535      : 1        |                                        |
     65536 -> 131071     : 0        |                                        |
    131072 -> 262143     : 4        |                                        |
    262144 -> 524287     : 7807     |****************************************|
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 1        |                                        |
      2048 -> 4095       : 88       |****************************************|
      4096 -> 8191       : 8        |***                                     |
      8192 -> 16383      : 2        |                                        |
     16384 -> 32767      : 2        |                                        |

Compress bz=8192 nb=1×1000000, speed=1237.5 MB/s (±0.0% N=1) overall=215.1 MB/s (±0.0%)

CPU做：

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000 -z -c

Tracing... Hit Ctrl-C to end.
io pf duration dist:
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 87       |**                                      |
      1024 -> 2047       : 241      |*******                                 |
      2048 -> 4095       : 17       |                                        |
      4096 -> 8191       : 10       |                                        |
      8192 -> 16383      : 6        |                                        |
     16384 -> 32767      : 2        |                                        |
     32768 -> 65535      : 0        |                                        |
     65536 -> 131071     : 0        |                                        |
    131072 -> 262143     : 358      |**********                              |
    262144 -> 524287     : 1311     |****************************************|

Compress bz=8192 nb=1×1000000, speed=70.5 MB/s (±0.0% N=1) overall=55.5 MB/s (±0.0%)

Todo: CPU这个数据有点问题，在准备数据的时候已经搞大页了，这个没有统计到，还是
      隔了30s在开始统计。实际上CPU 262us - 524us这个点要比这个多。 

7. 硬件加速 + 开THP/关THP + 绑cpu/mem + pre-fault
-------------------------------------------------

 使用的内存全部提前缺页，然后控制THP这个变量，就控制实际的页大小，实际上就是看
 TLB miss对加速器性能的影响。

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000 -o perf

开THP：

Tracing... Hit Ctrl-C to end.
io pf duration dist:
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 1        |******                                  |
      2048 -> 4095       : 1        |******                                  |
      4096 -> 8191       : 5        |*********************************       |
      8192 -> 16383      : 6        |****************************************|
     16384 -> 32767      : 1        |******                                  |

Compress bz=8192 nb=1×1000000, speed=2145.2 MB/s (±0.0% N=1) overall=213.6 MB/s (±0.0%)

关THP：

Tracing... Hit Ctrl-C to end.
io pf duration dist:
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 2        |*************                           |
      4096 -> 8191       : 6        |****************************************|
      8192 -> 16383      : 4        |**************************              |

Compress bz=8192 nb=1×1000000, speed=1963.7 MB/s (±0.0% N=1) overall=198.7 MB/s (±0.0%)

结论：TLB miss对于我们这样的顺序的内存模型影响不大。


8. 硬件加速 + 开THP + 绑cpu/mem + 不pre-fault + 其他内存背景噪声
----------------------------------------------------------------

内存噪声起10个这样的进程：
```
#include <malloc.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define MEM_SIZE	(1024 * 1024 * 1024)
#define SLEEP_TIME	1

int main()
{
	void *p;
	unsigned long i;

	for (i = 0; i < 100000000; i++) {
		p = malloc(MEM_SIZE);
		if (!p)
			exit(1);

		memset(p, 3, MEM_SIZE);

		free(p);
	}

	return 0;
}
```

sudo numactl --cpubind=1 --membind=1 zip_sva_perf -b 8192 -s 8192000000

Tracing... Hit Ctrl-C to end.
io pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 0        |                                        |
      1024 -> 2047       : 0        |                                        |
      2048 -> 4095       : 0        |                                        |
      4096 -> 8191       : 48       |                                        |
      8192 -> 16383      : 163      |                                        |
     16384 -> 32767      : 13       |                                        |
     32768 -> 65535      : 4        |                                        |
     65536 -> 131071     : 0        |                                        |
    131072 -> 262143     : 1        |                                        |
    262144 -> 524287     : 0        |                                        |
    524288 -> 1048575    : 7076     |****************************************|
   1048576 -> 2097151    : 735      |****                                    |
cpu pf duration dist:
     nsecs               : count     distribution
         0 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 0        |                                        |
         8 -> 15         : 0        |                                        |
        16 -> 31         : 0        |                                        |
        32 -> 63         : 0        |                                        |
        64 -> 127        : 0        |                                        |
       128 -> 255        : 0        |                                        |
       256 -> 511        : 0        |                                        |
       512 -> 1023       : 57       |                                        |
      1024 -> 2047       : 5381086  |****************                        |
      2048 -> 4095       : 13206232 |****************************************|
      4096 -> 8191       : 3112186  |*********                               |
      8192 -> 16383      : 475167   |*                                       |
     16384 -> 32767      : 98426    |                                        |
     32768 -> 65535      : 18952    |                                        |
     65536 -> 131071     : 1096     |                                        |
    131072 -> 262143     : 382      |                                        |
    262144 -> 524287     : 6027     |                                        |
    524288 -> 1048575    : 345987   |*                                       |
   1048576 -> 2097151    : 1102     |                                        |
   2097152 -> 4194303    : 2        |                                        |

Compress bz=8192 nb=1×1000000, speed=644.1 MB/s (±0.0% N=1) overall=185.4 MB/s (±0.0%)

结论：有背景噪声的场景下，开THP，关numa balancing，性能下降较多。iopf的统计特征
      和没有背景噪声的时候基本一样。cpu fault很多，但是目前的统计把背景噪声的
      cpu fault也统计进来。(todo: 可否只统计一个进程的cpu fault?)
